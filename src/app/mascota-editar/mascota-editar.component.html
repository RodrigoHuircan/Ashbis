<ion-header translucent="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/mascotas"></ion-back-button>
    </ion-buttons>
    <ion-title>Editar Perfil</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ng-container *ngIf="!loading(); else skel">
    <ion-grid fixed *ngIf="mascota() as m">
      <ion-row class="ion-justify-content-center ion-padding-top">
        <!-- Menú lateral -->
        <ion-col size="12" sizeMd="4" sizeLg="3">
          <ion-list lines="none">
            <ion-item class="ion-text-center" lines="none">
              <ion-avatar style="margin:0 auto;">
                <img [src]="avatar" alt="foto" />
              </ion-avatar>
            </ion-item>

            <ion-item lines="none">
              <ion-label class="ion-text-center" style="font-weight:700">{{ m.nombre }}</ion-label>
            </ion-item>

            <ion-item lines="none">
              <ion-button expand="block" [fill]="section()==='info' ? 'solid' : 'outline'" color="danger" (click)="setSection('info')">
                Info Mascota
              </ion-button>
            </ion-item>

            <ion-item lines="none">
              <ion-button expand="block" [fill]="section()==='calendario' ? 'solid' : 'outline'" color="medium" (click)="setSection('calendario')">
                Calendario
              </ion-button>
            </ion-item>

            <ion-item lines="none">
              <ion-button expand="block" [fill]="section()==='vacunas' ? 'solid' : 'outline'" color="medium" (click)="setSection('vacunas')">
                Vacunas
              </ion-button>
            </ion-item>

            <ion-item lines="none">
              <ion-button expand="block" [fill]="section()==='historial' ? 'solid' : 'outline'" color="medium" (click)="setSection('historial')">
                Historial Veterinario
              </ion-button>
            </ion-item>

            <ion-item lines="none">
              <ion-button expand="block" [fill]="section()==='medicamentos' ? 'solid' : 'outline'" color="medium" (click)="setSection('medicamentos')">
                Medicamentos
              </ion-button>
            </ion-item>

            <ion-item lines="none">
              <ion-button expand="block" [fill]="section()==='examenes' ? 'solid' : 'outline'" color="medium" (click)="setSection('examenes')">
                Exámenes
              </ion-button>
            </ion-item>
          </ion-list>
        </ion-col>

        <!-- Contenido -->
        <ion-col size="12" sizeMd="8" sizeLg="7">
          <!-- INFO (editable) -->
          <form *ngIf="section()==='info'" [formGroup]="form" (ngSubmit)="guardarInfo()">
            <ion-list inset="true">
              <ion-item>
                <ion-label position="stacked">Nombre</ion-label>
                <ion-input formControlName="nombre" clearInput></ion-input>
                <ion-note color="danger" *ngIf="form.get('nombre')?.touched && form.get('nombre')?.invalid">
                  Requerido (máx. 60)
                </ion-note>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Número de chip</ion-label>
                <ion-input formControlName="numeroChip" inputmode="numeric" clearInput></ion-input>
                <ion-note color="danger" *ngIf="form.get('numeroChip')?.touched && form.get('numeroChip')?.invalid">
                  Solo números
                </ion-note>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Edad</ion-label>
                <ion-input type="number" formControlName="edad" inputmode="numeric" min="0" clearInput></ion-input>
                <ion-note color="danger" *ngIf="form.get('edad')?.touched && form.get('edad')?.invalid">
                  Debe ser ≥ 0
                </ion-note>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Sexo</ion-label>
                <ion-select formControlName="sexo" interface="popover" placeholder="Selecciona">
                  <ion-select-option value="Macho">Macho</ion-select-option>
                  <ion-select-option value="Hembra">Hembra</ion-select-option>
                  <ion-select-option value="No binario">No binario</ion-select-option>
                </ion-select>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Especie</ion-label>
                <ion-select formControlName="especie" interface="popover" placeholder="Perro, Gato, Otro">
                  <ion-select-option value="Perro">Perro</ion-select-option>
                  <ion-select-option value="Gato">Gato</ion-select-option>
                  <ion-select-option value="Otro">Otro</ion-select-option>
                </ion-select>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Raza</ion-label>
                <ion-input formControlName="raza" clearInput></ion-input>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Color</ion-label>
                <ion-input formControlName="color" clearInput></ion-input>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Castrado / Esterilizado</ion-label>
                <ion-select formControlName="castrado" interface="popover" placeholder="Selecciona">
                  <ion-select-option value="Sí">Sí</ion-select-option>
                  <ion-select-option value="No">No</ion-select-option>
                </ion-select>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Fecha de nacimiento</ion-label>
                <ion-datetime-button datetime="dt-nac" class="ion-margin-top ion-margin-bottom"></ion-datetime-button>
                <ion-modal [keepContentsMounted]="true">
                  <ng-template>
                    <ion-datetime
                      id="dt-nac"
                      presentation="date"
                      [max]="fechaMax"
                      [value]="form.get('fechaNacimiento')?.value"
                      (ionChange)="onIonDateChange($event)"
                      locale="es-ES">
                    </ion-datetime>
                  </ng-template>
                </ion-modal>
                <ion-note slot="end" color="medium">
                  {{ form.get('fechaNacimiento')?.value ? (form.get('fechaNacimiento')?.value | date:'dd-MM-yyyy') : 'Sin seleccionar' }}
                </ion-note>
              </ion-item>
            </ion-list>

            <ion-button
              type="submit"
              expand="block"
              color="danger"
              [disabled]="saving() || form.invalid">
              {{ saving() ? 'Guardando...' : 'Guardar cambios' }}
            </ion-button>

            <!-- GALERÍA -->
            <ion-list inset="true" class="ion-margin-top">
              <ion-item lines="full">
                <ion-label>
                  <h3>Galería</h3>
                  <p class="ion-text-wrap">Añade o elimina fotos de tu mascota.</p>
                </ion-label>
                <input
                  type="file"
                  multiple
                  accept="image/*"
                  hidden
                  #galInput
                  (change)="onAddPhotos($event)" />
                <ion-button slot="end" color="danger" [disabled]="uploading()" (click)="galInput.click()">
                  <ion-icon name="images-outline" slot="start"></ion-icon>
                  {{ uploading() ? 'Subiendo…' : 'Agregar fotos' }}
                </ion-button>
              </ion-item>

              <ion-item lines="none" *ngIf="mascota()?.galeria?.length; else noGal">
                <ion-grid>
                  <ion-row>
                    <ion-col size="5" sizeMd="5" sizeLg="5" *ngFor="let url of mascota()?.galeria">
                      <ion-card class="gal-thumb">
                        <img [src]="url" alt="foto" />
                        <ion-card-content>
                          <ion-button size="small" fill="outline" color="medium" (click)="setAsPrincipal(url)">
                            Principal
                          </ion-button>
                          <ion-button size="small" fill="solid" color="danger" (click)="onRemovePhoto(url)">
                            <ion-icon name="trash-outline" slot="start"></ion-icon>
                            Borrar
                          </ion-button>
                        </ion-card-content>
                      </ion-card>
                    </ion-col>
                  </ion-row>
                </ion-grid>
              </ion-item>

              <ng-template #noGal>
                <ion-item>
                  <ion-label color="medium">Sin fotos en galería.</ion-label>
                </ion-item>
              </ng-template>
            </ion-list>
          </form>

          <!-- PLACEHOLDERS -->
          <ion-list *ngIf="section()==='calendario'">
            <ion-item><ion-label>Calendario (próximamente)</ion-label></ion-item>
          </ion-list>

          <ion-list *ngIf="section()==='vacunas'">
            <ion-item><ion-label>Vacunas (próximamente)</ion-label></ion-item>
          </ion-list>

          <ion-list *ngIf="section()==='historial'">
            <ion-item><ion-label>Historial Veterinario (próximamente)</ion-label></ion-item>
          </ion-list>

          <ion-list *ngIf="section()==='medicamentos'">
            <ion-item><ion-label>Medicamentos (próximamente)</ion-label></ion-item>
          </ion-list>

          <ion-list *ngIf="section()==='examenes'">
            <ion-item><ion-label>Exámenes (próximamente)</ion-label></ion-item>
          </ion-list>
        </ion-col>
      </ion-row>
    </ion-grid>
  </ng-container>

  <ng-template #skel>
    <ion-list>
      <ion-item>
        <ion-avatar slot="start"></ion-avatar>
        <ion-label><h3>Cargando...</h3></ion-label>
      </ion-item>
    </ion-list>
  </ng-template>

  <!-- Toast -->
  <ion-toast
    [isOpen]="toastOpen()"
    [message]="toastMsg() || ''"
    duration="1800"
    (didDismiss)="toastOpen.set(false)">
  </ion-toast>
</ion-content>
