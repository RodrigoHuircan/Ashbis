<ion-header translucent="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/home"></ion-back-button>
    </ion-buttons>
    <ion-title>Agregar Mascota</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-grid fixed>
    <ion-row class="ion-justify-content-center">
      <ion-col size="12" size-md="8" size-lg="6">

        <!-- Imagen -->
        <ion-list lines="none">
          <ion-item>
            <ion-img
              [src]="imagenPreview || 'assets/img/logo_ashbis.jpeg'"
              alt="Foto Mascota"
              style="width:140px;height:140px;border-radius:20px;object-fit:cover;margin:12px auto"
            ></ion-img>
          </ion-item>

          <ion-item lines="none" class="ion-text-center">
            <input type="file" accept="image/*" (change)="onImageSelected($event)" hidden #fileInput />
            <ion-button size="small" fill="outline" (click)="fileInput.click()" color="danger">
              <ion-icon name="image-outline" slot="start"></ion-icon>
              Seleccionar foto
            </ion-button>
          </ion-item>
        </ion-list>

        <!-- Formulario -->
        <form [formGroup]="mascotaForm" (ngSubmit)="guardarMascota()">
          <ion-list inset="true">

            <!-- Nombre -->
            <ion-item fill="solid">
              <ion-label position="stacked">Nombre</ion-label>
              <ion-input formControlName="nombre" placeholder="Nombre de la mascota" clearInput></ion-input>
              <ion-note color="danger" *ngIf="mascotaForm.get('nombre')?.touched && mascotaForm.get('nombre')?.invalid">
                El nombre es obligatorio.
              </ion-note>              
            </ion-item>

            <!-- Número de chip -->
            <ion-item class="ion-margin-top" fill="solid">
              <ion-label position="stacked">Número de chip</ion-label>
              <ion-input type="number" formControlName="numeroChip" inputmode="numeric" placeholder="Ej: 1234567890" clearInput></ion-input>
              <ion-note color="danger" *ngIf="mascotaForm.get('numeroChip')?.touched && mascotaForm.get('numeroChip')?.invalid">
                Ingresa sólo números.
              </ion-note>              
            </ion-item>

            <!-- Edad -->
            <ion-item class="ion-margin-top" fill="solid">
              <ion-label position="stacked">Edad</ion-label>
              <ion-input type="number" formControlName="edad" inputmode="numeric" placeholder="Ej: 2" clearInput></ion-input>
              <ion-note color="danger" *ngIf="mascotaForm.get('edad')?.touched && mascotaForm.get('edad')?.invalid">
                La edad debe ser 0 o mayor.
              </ion-note>              
            </ion-item>

            <!-- Sexo -->
            <ion-item class="ion-margin-top" fill="solid">
              <ion-label position="stacked">Sexo</ion-label>
              <ion-select formControlName="sexo" interface="popover" placeholder="Selecciona sexo">
                <ion-select-option value="Macho">Macho</ion-select-option>
                <ion-select-option value="Hembra">Hembra</ion-select-option>
              </ion-select>
              <ion-note color="danger" *ngIf="mascotaForm.get('sexo')?.touched && mascotaForm.get('sexo')?.invalid">
                Selecciona el sexo.
              </ion-note>              
            </ion-item>

            <!-- Fecha de nacimiento con IonDatetime -->
            <ion-item class="ion-margin-top" fill="solid">
              <ion-label position="stacked">Fecha de nacimiento</ion-label>

              <!-- Botón que abre el modal -->
              <ion-datetime-button datetime="picker-fecha" class="ion-margin-top ion-margin-bottom"></ion-datetime-button>

              <!-- Modal + Datetime -->
              <ion-modal [keepContentsMounted]="true">
                <ng-template>
                  <ion-datetime
                    id="picker-fecha"
                    presentation="date"
                    [max]="fechaActual"
                    locale="es-ES"
                    (ionChange)="onIonDateChange($event)">
                  </ion-datetime>
                </ng-template>
              </ion-modal>

              <!-- Vista legible seleccionada -->
              <ion-note slot="end" color="medium">{{ fechaFormateada || 'Sin seleccionar' }}</ion-note>
              <ion-note color="danger" *ngIf="mascotaForm.get('fechaNacimiento')?.touched && mascotaForm.get('fechaNacimiento')?.invalid">
                La fecha de nacimiento es obligatoria.
              </ion-note>              
            </ion-item>

            <!-- Especie -->
            <ion-item class="ion-margin-top" fill="solid">
              <ion-label position="stacked">Especie</ion-label>
              <ion-select formControlName="especie" interface="popover" placeholder="Perro, Gato, Otro">
                <ion-select-option value="Perro">Perro</ion-select-option>
                <ion-select-option value="Gato">Gato</ion-select-option>
                <ion-select-option value="Otro">Otro</ion-select-option>
              </ion-select>
              <ion-note color="danger" *ngIf="mascotaForm.get('especie')?.touched && mascotaForm.get('especie')?.invalid">
                Selecciona la especie.
              </ion-note>            
            </ion-item>


            <!-- Color -->
            <ion-item class="ion-margin-top" fill="solid">
              <ion-label position="stacked">Color</ion-label>
              <ion-input formControlName="color" placeholder="Ej: Marrón, Negro..." clearInput></ion-input>
              <ion-note color="danger" *ngIf="mascotaForm.get('color')?.touched && mascotaForm.get('color')?.invalid">
                El color es obligatorio.
              </ion-note>              
            </ion-item>


            <!-- Raza -->
            <ion-item class="ion-margin-top" fill="solid">
              <ion-label position="stacked">Raza</ion-label>
              <ion-input formControlName="raza" placeholder="Ej: Labrador, Persa..." clearInput></ion-input>
              <ion-note color="danger" *ngIf="mascotaForm.get('raza')?.touched && mascotaForm.get('raza')?.invalid">
                La raza es obligatoria.
              </ion-note>              
            </ion-item>

            <!-- Castrado -->
            <ion-item class="ion-margin-top" fill="solid">
              <ion-label position="stacked">Castrado / Esterilizado</ion-label>
              <ion-select formControlName="castrado" interface="popover" placeholder="Selecciona una opción">
                <ion-select-option value="Sí">Sí</ion-select-option>
                <ion-select-option value="No">No</ion-select-option>
              </ion-select>
              <ion-note color="danger" *ngIf="mascotaForm.get('castrado')?.touched && mascotaForm.get('castrado')?.invalid">
                Indica si está castrado/esterilizado.
              </ion-note>              
            </ion-item>

          </ion-list>

          <ion-button
            type="submit"
            expand="block"
            shape="round"
            class="ion-margin-top"
            [disabled]="cargando || mascotaForm.invalid"
            color="danger">
            {{ cargando ? 'Guardando...' : 'Guardar Mascota' }}
          </ion-button>
        </form>

      </ion-col>
    </ion-row>
  </ion-grid>
</ion-content>
