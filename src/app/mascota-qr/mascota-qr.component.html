<ion-header class="header">
  <ion-toolbar class="header">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/listar-mascotas"></ion-back-button>
    </ion-buttons>
    <ion-title>QR de Mascota</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">

  <!-- Spinner de Carga -->
  <div *ngIf="cargando()" class="ion-text-center ion-padding-top">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Cargando información...</p>
  </div>

  <div *ngIf="!cargando()">

    <!-- Caso: No hay mascotas -->
    <ion-card *ngIf="misMascotas().length === 0" color="warning" class="ion-text-center">
      <ion-card-header>
        <ion-card-title>Sin Mascotas</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <p>No tienes mascotas registradas para generar un código QR.</p>
        <ion-button fill="outline" color="dark" class="ion-margin-top" [routerLink]="['/tabs/crear-mascotas']">
          Registrar Mascota
        </ion-button>
      </ion-card-content>
    </ion-card>

    <!-- Caso: Hay mascotas -->
    <div *ngIf="misMascotas().length > 0">
      
      <!-- Selector de Mascota -->
<ion-item lines="none" class="mascota-selector rojo ion-margin-bottom">
  
  <ion-avatar slot="start">
    <img [src]="mascotaSeleccionada()?.fotoUrl || 'assets/img/logo_ashbis.jpeg'" alt="avatar">
  </ion-avatar>

  <ion-label position="stacked" class="rojo-label">
    Selecciona tu mascota
  </ion-label>

  <ion-select 
    [value]="mascotaSeleccionada()?.id" 
    (ionChange)="onMascotaChange($event)"
    interface="popover"
    placeholder="Elegir mascota"
    class="select-rojo"
  >
    <ion-select-option 
      *ngFor="let m of misMascotas()" 
      [value]="m.id">
      {{ m.nombre }}
    </ion-select-option>
  </ion-select>

</ion-item>


      <!-- Tarjeta del QR -->
      <div *ngIf="qrData; else faltanDatos" class="fade-in">
        <ion-card class="ion-text-center qr-card" #qrContainer id="qrCardElement">
          <ion-card-header>
            <ion-card-title class="titulo-qr">{{ mascotaSeleccionada()?.nombre }}</ion-card-title>
            <ion-card-subtitle>{{ mascotaSeleccionada()?.especie }}</ion-card-subtitle>
          </ion-card-header>

          <ion-card-content class="qr-content">
            <div class="qr-code-wrapper">
              <qrcode 
                [qrdata]="qrData" 
                [width]="260" 
                [margin]="2"
                errorCorrectionLevel="M">
              </qrcode>
            </div>
            <p class="instruccion">Escanea para ver la ficha completa y contactar al dueño</p>
          </ion-card-content>
        </ion-card>

        <!-- Botones de Acción -->
        <div class="acciones ion-padding-top">
          <ion-button expand="block" (click)="descargarPDF()" [disabled]="descargandoPDF" 
          color="danger">
            <ion-icon name="document-text-outline" slot="start"></ion-icon>
            <ion-spinner *ngIf="descargandoPDF" slot="start"></ion-spinner>
            {{ descargandoPDF ? 'Generando PDF...' : 'Descargar Ficha PDF' }}
          </ion-button>

          <ion-button *ngIf="canShare" expand="block" fill="outline" class="compartir-btn ion-margin-top" (click)="compartirQR()" [disabled]="compartiendo">
            <ion-icon name="share-outline" slot="start"></ion-icon>
            {{ compartiendo ? 'Compartiendo...' : 'Compartir' }}
          </ion-button>
        </div>
      </div>

      <!-- Template: Faltan datos de contacto -->
      <ng-template #faltanDatos>
        <ion-card color="danger">
          <ion-card-content>
            <p>
              <strong>¡Faltan datos de contacto!</strong><br>
              Para generar la ficha QR de {{ mascotaSeleccionada()?.nombre }}, es obligatorio tener un <strong>Teléfono</strong> configurado en tu perfil de usuario.
            </p>
            <ion-button fill="solid" color="light" class="ion-margin-top" [routerLink]="['/tabs/perfil']">
              Ir a mi Perfil
            </ion-button>
          </ion-card-content>
        </ion-card>
      </ng-template>

    </div>
  </div>
</ion-content>